{
    "name": "TCU-Strava-AIæ•™ç·´-æ¯æ—¥æ‘˜è¦-å¿«å–ç‰ˆ",
    "nodes": [
        {
            "parameters": {
                "httpMethod": "POST",
                "path": "ai-coach-summary",
                "responseMode": "responseNode",
                "options": {
                    "rawBody": false
                }
            },
            "id": "83caae47-a172-4e51-a83d-beaa0804d4a4",
            "name": "æ¥æ”¶æ‘˜è¦è«‹æ±‚",
            "type": "n8n-nodes-base.webhook",
            "typeVersion": 2.1,
            "position": [
                880,
                -192
            ],
            "webhookId": "ai-coach-summary"
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "SELECT ai_response, context_data, created_at\nFROM ai_coach_logs\nWHERE athlete_id = {{ $json.body.athlete_id }}::bigint\n  AND type = 'summary'\n  AND created_at >= CURRENT_DATE\nORDER BY created_at DESC\nLIMIT 1;",
                "options": {}
            },
            "id": "check-existing-summary-001",
            "name": "æª¢æŸ¥ä»Šæ—¥æ‘˜è¦",
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.5,
            "position": [
                1100,
                0
            ],
            "alwaysOutputData": true,
            "credentials": {
                "postgres": {
                    "id": "EyymWfYG639Eg1jJ",
                    "name": "Postgres account"
                }
            }
        },
        {
            "parameters": {
                "conditions": {
                    "string": [
                        {
                            "value1": "={{ $json.ai_response }}",
                            "operation": "isNotEmpty"
                        }
                    ]
                }
            },
            "id": "if-summary-exists-001",
            "name": "åˆ¤æ–·æ˜¯å¦å·²ç”Ÿæˆ",
            "type": "n8n-nodes-base.if",
            "typeVersion": 2,
            "position": [
                1320,
                0
            ]
        },
        {
            "parameters": {
                "jsCode": "// === æ ¼å¼åŒ–ç¾æœ‰æ‘˜è¦ ===\n// NOTE: å¦‚æœ DB å·²æœ‰ä»Šæ—¥æ‘˜è¦ï¼Œç›´æ¥è½‰ç‚ºå‰ç«¯æ ¼å¼å›å‚³\n\nconst log = $input.first().json;\n\n// context_data åœ¨ DB ä¸­æ˜¯ JSONBï¼ŒN8N è®€å‡ºä¾†å¯èƒ½æ˜¯ç‰©ä»¶æˆ–å­—ä¸²ï¼Œéœ€ç¢ºèª\nlet metrics = {};\nif (typeof log.context_data === 'string') {\n  try { metrics = JSON.parse(log.context_data); } catch(e) {}\n} else {\n  metrics = log.context_data || {};\n}\n// æœ‰æ™‚å€™ context_data è¢«å¤šå±¤ stringifyï¼Œå¯èƒ½éœ€è¦å† parse ä¸€æ¬¡\nif (typeof metrics === 'string') {\n  try { metrics = JSON.parse(metrics); } catch(e) {}\n}\n\nreturn [{\n  json: {\n    summary: log.ai_response,\n    metrics: metrics\n  }\n}];"
            },
            "id": "format-existing-summary-001",
            "name": "æ ¼å¼åŒ–ç¾æœ‰æ‘˜è¦",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                1540,
                -160
            ]
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "SELECT \n  sa.name,\n  sa.start_date_local,\n  sa.distance,\n  sa.moving_time,\n  sa.elapsed_time,\n  sa.total_elevation_gain,\n  sa.average_speed,\n  sa.average_watts,\n  sa.max_watts,\n  sa.weighted_average_watts,\n  sa.kilojoules,\n  sa.average_heartrate,\n  sa.max_heartrate,\n  sa.type\nFROM strava_activities sa\nWHERE sa.athlete_id = {{ $('æ¥æ”¶æ‘˜è¦è«‹æ±‚').first().json.body.athlete_id }}::bigint\nORDER BY sa.start_date_local DESC\nLIMIT 5",
                "options": {}
            },
            "id": "766ec789-e0dc-484f-87c7-1b2f28514f77",
            "name": "æŸ¥è©¢ç•¶æ—¥æ´»å‹•",
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.5,
            "position": [
                1540,
                160
            ],
            "alwaysOutputData": true,
            "credentials": {
                "postgres": {
                    "id": "EyymWfYG639Eg1jJ",
                    "name": "Postgres account"
                }
            }
        },
        {
            "parameters": {
                "jsCode": "// === è¨ˆç®—ç•¶æ—¥è¨“ç·´æŒ‡æ¨™ ===\n// NOTE: å½™æ•´ç•¶æ—¥æ´»å‹•æ•¸æ“šï¼Œè¨ˆç®— metrics ä¾›å‰ç«¯ DailySummaryCard ä½¿ç”¨\n\nconst items = $input.all();\nconst requestData = $('æ¥æ”¶æ‘˜è¦è«‹æ±‚').first().json.body;\nconst date = requestData.date || new Date().toISOString().split('T')[0];\n\nif (!items || items.length === 0 || !items[0].json.name) {\n  return [{\n    json: {\n      hasData: false,\n      date,\n      metrics: {\n        total_time_min: 0,\n        total_distance_km: 0,\n        activities_count: 0,\n        details: ['ä»Šå¤©æ²’æœ‰é¨ä¹˜ç´€éŒ„']\n      }\n    }\n  }];\n}\n\nlet totalTime = 0;\nlet totalDistance = 0;\nconst details = [];\n\nfor (const item of items) {\n  const d = item.json;\n  const dist = parseFloat(d.distance) || 0;\n  const time = parseInt(d.moving_time) || 0;\n  const avgW = parseFloat(d.average_watts) || 0;\n  const np = parseFloat(d.weighted_average_watts) || 0;\n  const elev = parseFloat(d.total_elevation_gain) || 0;\n  const avgHR = parseFloat(d.average_heartrate) || 0;\n\n  totalTime += time;\n  totalDistance += dist;\n\n  let detail = `ğŸš´ ${d.name}: ${(dist/1000).toFixed(1)}km, ${Math.round(time/60)}åˆ†é˜`;\n  if (avgW > 0) detail += `, å‡åŠŸç‡${Math.round(avgW)}W`;\n  if (np > 0) detail += `, NP ${Math.round(np)}W`;\n  if (elev > 0) detail += `, çˆ¬å‡${Math.round(elev)}m`;\n  if (avgHR > 0) detail += `, å‡å¿ƒç‡${Math.round(avgHR)}bpm`;\n  details.push(detail);\n}\n\nreturn [{\n  json: {\n    hasData: true,\n    date,\n    metrics: {\n      total_time_min: Math.round(totalTime / 60),\n      total_distance_km: parseFloat((totalDistance / 1000).toFixed(1)),\n      activities_count: items.length,\n      details\n    },\n    activitiesForAI: items.map(i => ({\n      name: i.json.name,\n      distance_km: (parseFloat(i.json.distance || 0) / 1000).toFixed(1),\n      time_min: Math.round(parseInt(i.json.moving_time || 0) / 60),\n      avg_watts: Math.round(parseFloat(i.json.average_watts || 0)),\n      np: Math.round(parseFloat(i.json.weighted_average_watts || 0)),\n      elevation: Math.round(parseFloat(i.json.total_elevation_gain || 0)),\n      avg_hr: Math.round(parseFloat(i.json.average_heartrate || 0))\n    }))\n  }\n}];"
            },
            "id": "0e1fa3cb-aa56-44e1-9393-efa576f63efa",
            "name": "è¨ˆç®—ç•¶æ—¥æŒ‡æ¨™",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                1800,
                160
            ]
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "SELECT id, brand_name, product_name, product_url, description, placement_text\nFROM ad_placements\nWHERE is_active = true\n  AND (start_date IS NULL OR start_date <= CURRENT_DATE)\n  AND (end_date IS NULL OR end_date >= CURRENT_DATE)\n  AND (max_impressions IS NULL OR current_impressions < max_impressions)\nORDER BY priority ASC\nLIMIT 10;",
                "options": {}
            },
            "id": "87f51a3d-249f-41f2-8437-ad7cda9e4742",
            "name": "æŸ¥è©¢å¯ç”¨å»£å‘Š",
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.5,
            "position": [
                2060,
                160
            ],
            "alwaysOutputData": true,
            "credentials": {
                "postgres": {
                    "id": "EyymWfYG639Eg1jJ",
                    "name": "Postgres account"
                }
            }
        },
        {
            "parameters": {
                "promptType": "define",
                "text": "=æ—¥æœŸï¼š{{ $('è¨ˆç®—ç•¶æ—¥æŒ‡æ¨™').first().json.date }}\n\nä»Šæ—¥æ´»å‹•æ•¸æ“šï¼š\n{{ JSON.stringify($('è¨ˆç®—ç•¶æ—¥æŒ‡æ¨™').first().json.activitiesForAI, null, 2) }}\n\nè¨“ç·´æŒ‡æ¨™æ‘˜è¦ï¼š\n{{ JSON.stringify($('è¨ˆç®—ç•¶æ—¥æŒ‡æ¨™').first().json.metrics, null, 2) }}\n\nå¯ç”¨çš„æ¨è–¦å•†å“ï¼ˆåƒ…åœ¨é«˜åº¦ç›¸é—œæ™‚æ‰æ¨è–¦ 1 å€‹ï¼‰ï¼š\n{{ $json.brand_name ? JSON.stringify($('æŸ¥è©¢å¯ç”¨å»£å‘Š').all().map(i => i.json)) : 'ç„¡' }}",
                "options": {
                    "systemMessage": "ä½ æ˜¯ TCU è»ŠéšŠçš„ã€ŒAI æ•™ç·´æ—¥èªŒã€åŠ©æ‰‹ã€‚\n\nä½ çš„ä»»å‹™æ˜¯é‡å°é¸æ‰‹**æœ€è¿‘å¹¾æ¬¡é¨ä¹˜æ´»å‹•**ï¼Œå¯«ä¸€æ®µç°¡çŸ­çš„è¨“ç·´æ—¥èªŒæ‘˜è¦èˆ‡å»ºè­°ï¼ˆç´„ 150-200 å­—ï¼‰ã€‚\n\næ ¼å¼è¦æ±‚ï¼š\n- **è¿‘æœŸè¨“ç·´é‡é»**ï¼šæ¦‚è¿°æœ€è¿‘çš„è¨“ç·´é¡å‹èˆ‡å¼·åº¦\n- **è¡¨ç¾è©•ä¼°**ï¼šå¾åŠŸç‡ã€å¿ƒç‡ã€è·é›¢ç­‰è§’åº¦è©•ä¼°\n- **æ¥ä¸‹ä¾†çš„å»ºè­°**ï¼šçµ¦å‡º 2-3 æ¢å…·é«”è¨“ç·´å»ºè­°\n\né¢¨æ ¼ï¼šç°¡æ½”ã€é¼“å‹µã€ä½¿ç”¨ emojiã€‚ä¸è¦åšé•·æœŸè¶¨å‹¢åˆ†æã€‚\nç”¨ç¹é«”ä¸­æ–‡å›ç­”ã€‚\n\n## å»£å‘Šç½®å…¥æŒ‡å¼•\nå¦‚æœæä¾›çš„æ¨è–¦å•†å“èˆ‡è¨“ç·´å»ºè­°é«˜åº¦ç›¸é—œï¼Œå¯åœ¨å›è¦†æœ«å°¾ç”¨ä»¥ä¸‹æ ¼å¼è‡ªç„¶æ¨è–¦ 1 å€‹å•†å“ï¼š\n\nğŸ’¡ æ¨è–¦å¥½ç‰©ï¼š[å•†å“åç¨±]\n[ä¸€å¥è©±æ¨è–¦ç†ç”±]\nğŸ‘‰ [å•†å“é€£çµ]\n\nè¦å‰‡ï¼šåªåœ¨ç›´æ¥ç›¸é—œæ™‚æ¨è–¦ï¼Œä¸å¯å¼·è¡Œç½®å…¥ã€‚æ²’æœ‰ç›¸é—œå•†å“å°±ä¸æ¨è–¦ã€‚"
                }
            },
            "type": "@n8n/n8n-nodes-langchain.agent",
            "typeVersion": 3.1,
            "position": [
                2320,
                160
            ],
            "id": "870114fd-ebbe-4d6a-aaa4-9a0294b02a39",
            "name": "AI æ—¥èªŒæ‘˜è¦"
        },
        {
            "parameters": {
                "model": {
                    "__rl": true,
                    "mode": "list",
                    "value": "gpt-4o"
                },
                "responsesApiEnabled": false,
                "options": {}
            },
            "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
            "typeVersion": 1.3,
            "position": [
                2280,
                400
            ],
            "id": "9f7571b4-b275-427a-8885-2c4e082d7e35",
            "name": "OpenAI Chat Model",
            "credentials": {
                "openAiApi": {
                    "id": "K6aV6rRPPBUIjMxM",
                    "name": "Zeabur AI hub"
                }
            }
        },
        {
            "parameters": {
                "jsCode": "// === æ ¼å¼åŒ–æ¯æ—¥æ‘˜è¦å›æ‡‰ ===\n// NOTE: çµ„åˆ AI æ‘˜è¦æ–‡å­— + metricsï¼Œå›å‚³å‰ç«¯ DailySummaryCard é æœŸæ ¼å¼\n\nconst aiOutput = $input.first().json;\nconst calcData = $('è¨ˆç®—ç•¶æ—¥æŒ‡æ¨™').first().json;\n\nlet summary = '';\nif (!calcData.hasData) {\n  summary = 'ä»Šå¤©é‚„æ²’æœ‰é¨ä¹˜ç´€éŒ„ï¼Œä¼‘æ¯ä¹Ÿæ˜¯è¨“ç·´çš„ä¸€éƒ¨åˆ†ï¼ğŸŒŸ';\n} else {\n  summary = aiOutput.output || aiOutput.text || 'ä»Šæ—¥è¨“ç·´å·²å®Œæˆï¼';\n}\n\nreturn [{\n  json: {\n    summary,\n    metrics: calcData.metrics\n  }\n}];"
            },
            "id": "b43ab4a2-3b65-45b4-a222-ceda7433a560",
            "name": "æ ¼å¼åŒ–æ‘˜è¦å›æ‡‰",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                2600,
                160
            ]
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "INSERT INTO ai_coach_logs (athlete_id, type, ai_response, context_data)\nVALUES (\n  {{ $('æ¥æ”¶æ‘˜è¦è«‹æ±‚').first().json.body.athlete_id }}::bigint,\n  'summary',\n  '{{ $json.summary.replace(/'/g, \"''\") }}',\n  '{{ JSON.stringify($('è¨ˆç®—ç•¶æ—¥æŒ‡æ¨™').first().json.metrics).replace(/'/g, \"''\") }}'::jsonb\n);",
                "options": {}
            },
            "id": "88cf6a94-0476-4f15-b179-b7c335da0571",
            "name": "å„²å­˜æ—¥èªŒåˆ° Supabase",
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.5,
            "position": [
                2860,
                160
            ],
            "alwaysOutputData": true,
            "credentials": {
                "postgres": {
                    "id": "EyymWfYG639Eg1jJ",
                    "name": "Postgres account"
                }
            },
            "onError": "continueRegularOutput"
        },
        {
            "parameters": {
                "respondWith": "json",
                "responseBody": "={{ $('æ ¼å¼åŒ–æ‘˜è¦å›æ‡‰').itemMatching(0).json.summary ? $('æ ¼å¼åŒ–æ‘˜è¦å›æ‡‰').itemMatching(0).json : $('æ ¼å¼åŒ–ç¾æœ‰æ‘˜è¦').itemMatching(0).json }}",
                "options": {
                    "responseHeaders": {
                        "entries": [
                            {
                                "name": "Access-Control-Allow-Origin",
                                "value": "*"
                            },
                            {
                                "name": "Access-Control-Allow-Methods",
                                "value": "POST, OPTIONS"
                            },
                            {
                                "name": "Access-Control-Allow-Headers",
                                "value": "Content-Type"
                            }
                        ]
                    }
                }
            },
            "id": "40f639cd-4e73-4140-abc4-bfc17bb9e310",
            "name": "å›å‚³æ‘˜è¦çµæœ",
            "type": "n8n-nodes-base.respondToWebhook",
            "typeVersion": 1.1,
            "position": [
                3140,
                0
            ]
        }
    ],
    "connections": {
        "æ¥æ”¶æ‘˜è¦è«‹æ±‚": {
            "main": [
                [
                    {
                        "node": "æª¢æŸ¥ä»Šæ—¥æ‘˜è¦",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "æª¢æŸ¥ä»Šæ—¥æ‘˜è¦": {
            "main": [
                [
                    {
                        "node": "åˆ¤æ–·æ˜¯å¦å·²ç”Ÿæˆ",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "åˆ¤æ–·æ˜¯å¦å·²ç”Ÿæˆ": {
            "main": [
                [
                    {
                        "node": "æ ¼å¼åŒ–ç¾æœ‰æ‘˜è¦",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "æŸ¥è©¢ç•¶æ—¥æ´»å‹•",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "æ ¼å¼åŒ–ç¾æœ‰æ‘˜è¦": {
            "main": [
                [
                    {
                        "node": "å›å‚³æ‘˜è¦çµæœ",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "æŸ¥è©¢ç•¶æ—¥æ´»å‹•": {
            "main": [
                [
                    {
                        "node": "è¨ˆç®—ç•¶æ—¥æŒ‡æ¨™",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "è¨ˆç®—ç•¶æ—¥æŒ‡æ¨™": {
            "main": [
                [
                    {
                        "node": "æŸ¥è©¢å¯ç”¨å»£å‘Š",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "æŸ¥è©¢å¯ç”¨å»£å‘Š": {
            "main": [
                [
                    {
                        "node": "AI æ—¥èªŒæ‘˜è¦",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "AI æ—¥èªŒæ‘˜è¦": {
            "main": [
                [
                    {
                        "node": "æ ¼å¼åŒ–æ‘˜è¦å›æ‡‰",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "OpenAI Chat Model": {
            "ai_languageModel": [
                [
                    {
                        "node": "AI æ—¥èªŒæ‘˜è¦",
                        "type": "ai_languageModel",
                        "index": 0
                    }
                ]
            ]
        },
        "æ ¼å¼åŒ–æ‘˜è¦å›æ‡‰": {
            "main": [
                [
                    {
                        "node": "å„²å­˜æ—¥èªŒåˆ° Supabase",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "å„²å­˜æ—¥èªŒåˆ° Supabase": {
            "main": [
                [
                    {
                        "node": "å›å‚³æ‘˜è¦çµæœ",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        }
    },
    "settings": {
        "executionOrder": "v1"
    }
}