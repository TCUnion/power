{
    "name": "TCU-Strava-AIæ•™ç·´-ç«¯å°ç«¯æ¸¬è©¦-v2",
    "nodes": [
        {
            "parameters": {
                "httpMethod": "POST",
                "path": "ai-coach-test",
                "responseMode": "responseNode",
                "options": {
                    "rawBody": false
                }
            },
            "id": "2b95b653-719a-4d75-9b4e-207a73c329f1",
            "name": "æ¥æ”¶æ¸¬è©¦è«‹æ±‚",
            "type": "n8n-nodes-base.webhook",
            "typeVersion": 2.1,
            "position": [
                -224,
                -160
            ],
            "webhookId": "ai-coach-test"
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "SELECT \n  sa.id,\n  sa.name,\n  sa.start_date_local,\n  sa.distance,\n  sa.moving_time,\n  sa.elapsed_time,\n  sa.total_elevation_gain,\n  sa.average_speed,\n  sa.max_speed,\n  sa.average_watts,\n  sa.max_watts,\n  sa.weighted_average_watts,\n  sa.kilojoules,\n  sa.average_heartrate,\n  sa.max_heartrate,\n  sa.suffer_score,\n  sa.type\nFROM strava_activities sa\nWHERE sa.athlete_id = {{ $json.body.athlete_id }}::bigint\nORDER BY sa.start_date_local DESC\nLIMIT 500",
                "options": {}
            },
            "id": "af12956e-e1d0-4ff8-9e46-78dd94789963",
            "name": "æŸ¥è©¢å…¨éƒ¨æ­·å²æ´»å‹•",
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.5,
            "position": [
                64,
                -160
            ]
        },
        {
            "parameters": {
                "jsCode": "// === å½™æ•´å€‹äººé•·æœŸè¨“ç·´ç´€éŒ„ ===\n// NOTE: å¾ Strava å®Œæ•´æ­·å²æ´»å‹•ä¸­è¨ˆç®—é•·æœŸè¶¨å‹¢ã€æœˆåº¦çµ±è¨ˆã€é€²æ­¥æŒ‡æ¨™\n\nconst items = $input.all();\nconst userMessage = $('æ¥æ”¶æ¸¬è©¦è«‹æ±‚').first().json.body.message || 'åˆ†ææˆ‘çš„é¨ä¹˜è¡¨ç¾';\nconst athleteId = $('æ¥æ”¶æ¸¬è©¦è«‹æ±‚').first().json.body.athlete_id;\n\nif (!items || items.length === 0) {\n  return [{\n    json: {\n      hasData: false,\n      userMessage,\n      athleteId,\n      summary: 'æ²’æœ‰æ‰¾åˆ°ä»»ä½•é¨ä¹˜æ´»å‹•æ•¸æ“šã€‚'\n    }\n  }];\n}\n\n// --- å…¨æœŸçµ±è¨ˆ ---\nlet totalDistance = 0, totalTime = 0, totalElevation = 0, totalKJ = 0;\nlet maxAvgWatts = 0, maxMaxWatts = 0, bestNP = 0;\nconst activities = [];\nconst monthlyStats = {};\n\nfor (const item of items) {\n  const d = item.json;\n  const dist = parseFloat(d.distance) || 0;\n  const time = parseInt(d.moving_time) || 0;\n  const elev = parseFloat(d.total_elevation_gain) || 0;\n  const avgW = parseFloat(d.average_watts) || 0;\n  const maxW = parseFloat(d.max_watts) || 0;\n  const np = parseFloat(d.weighted_average_watts) || 0;\n  const kj = parseFloat(d.kilojoules) || 0;\n  const avgHR = parseFloat(d.average_heartrate) || 0;\n  const maxHR = parseFloat(d.max_heartrate) || 0;\n  const dateStr = d.start_date_local ? d.start_date_local.substring(0, 10) : null;\n  const monthKey = dateStr ? dateStr.substring(0, 7) : 'unknown';\n\n  totalDistance += dist;\n  totalTime += time;\n  totalElevation += elev;\n  totalKJ += kj;\n  if (avgW > maxAvgWatts) maxAvgWatts = avgW;\n  if (maxW > maxMaxWatts) maxMaxWatts = maxW;\n  if (np > bestNP) bestNP = np;\n\n  // æœˆåº¦çµ±è¨ˆ\n  if (!monthlyStats[monthKey]) {\n    monthlyStats[monthKey] = { rides: 0, distance: 0, time: 0, elevation: 0, totalWatts: 0, wattsCount: 0, totalNP: 0, npCount: 0 };\n  }\n  const ms = monthlyStats[monthKey];\n  ms.rides++;\n  ms.distance += dist;\n  ms.time += time;\n  ms.elevation += elev;\n  if (avgW > 0) { ms.totalWatts += avgW; ms.wattsCount++; }\n  if (np > 0) { ms.totalNP += np; ms.npCount++; }\n\n  activities.push({\n    name: d.name,\n    date: dateStr || 'N/A',\n    distance_km: (dist / 1000).toFixed(1),\n    moving_time_min: Math.round(time / 60),\n    elevation_m: Math.round(elev),\n    avg_watts: Math.round(avgW),\n    np: Math.round(np),\n    max_watts: Math.round(maxW),\n    avg_hr: Math.round(avgHR),\n    max_hr: Math.round(maxHR),\n    kj: Math.round(kj)\n  });\n}\n\n// --- æœˆåº¦è¶¨å‹¢ï¼ˆæœ€è¿‘ 6 å€‹æœˆï¼‰---\nconst sortedMonths = Object.keys(monthlyStats).sort().reverse().slice(0, 6);\nconst monthlyTrends = sortedMonths.map(m => {\n  const ms = monthlyStats[m];\n  return {\n    month: m,\n    rides: ms.rides,\n    distance_km: (ms.distance / 1000).toFixed(1),\n    time_hours: (ms.time / 3600).toFixed(1),\n    elevation_m: Math.round(ms.elevation),\n    avg_watts: ms.wattsCount > 0 ? Math.round(ms.totalWatts / ms.wattsCount) : 0,\n    avg_np: ms.npCount > 0 ? Math.round(ms.totalNP / ms.npCount) : 0\n  };\n});\n\n// --- è¿‘ 30 å¤© vs å‰ 30 å¤©æ¯”è¼ƒ ---\nconst now = new Date();\nconst d30 = new Date(now.getTime() - 30 * 86400000);\nconst d60 = new Date(now.getTime() - 60 * 86400000);\nlet recent30 = { rides: 0, distance: 0, time: 0, watts: 0, wCount: 0 };\nlet prev30 = { rides: 0, distance: 0, time: 0, watts: 0, wCount: 0 };\n\nfor (const a of activities) {\n  const ad = new Date(a.date);\n  if (ad >= d30) {\n    recent30.rides++; recent30.distance += parseFloat(a.distance_km); recent30.time += a.moving_time_min;\n    if (a.avg_watts > 0) { recent30.watts += a.avg_watts; recent30.wCount++; }\n  } else if (ad >= d60) {\n    prev30.rides++; prev30.distance += parseFloat(a.distance_km); prev30.time += a.moving_time_min;\n    if (a.avg_watts > 0) { prev30.watts += a.avg_watts; prev30.wCount++; }\n  }\n}\n\nconst comparison = {\n  recent30: {\n    rides: recent30.rides,\n    distance_km: recent30.distance.toFixed(1),\n    time_hours: (recent30.time / 60).toFixed(1),\n    avg_watts: recent30.wCount > 0 ? Math.round(recent30.watts / recent30.wCount) : 0\n  },\n  prev30: {\n    rides: prev30.rides,\n    distance_km: prev30.distance.toFixed(1),\n    time_hours: (prev30.time / 60).toFixed(1),\n    avg_watts: prev30.wCount > 0 ? Math.round(prev30.watts / prev30.wCount) : 0\n  }\n};\n\n// --- è¨ˆç®—æ—¥æœŸç¯„åœ ---\nconst dates = activities.map(a => a.date).filter(d => d !== 'N/A').sort();\nconst firstDate = dates[0] || 'N/A';\nconst lastDate = dates[dates.length - 1] || 'N/A';\n\nconst overallSummary = {\n  data_range: `${firstDate} ~ ${lastDate}`,\n  total_records: items.length,\n  total_distance_km: (totalDistance / 1000).toFixed(1),\n  total_time_hours: (totalTime / 3600).toFixed(1),\n  total_elevation_m: Math.round(totalElevation),\n  total_kj: Math.round(totalKJ),\n  best_avg_watts: Math.round(maxAvgWatts),\n  best_np: Math.round(bestNP),\n  best_max_watts: Math.round(maxMaxWatts),\n  avg_distance_per_ride_km: items.length > 0 ? (totalDistance / 1000 / items.length).toFixed(1) : 0,\n  avg_time_per_ride_min: items.length > 0 ? Math.round(totalTime / 60 / items.length) : 0\n};\n\nreturn [{\n  json: {\n    hasData: true,\n    userMessage,\n    athleteId,\n    overallSummary,\n    monthlyTrends,\n    comparison,\n    recentActivities: activities.slice(0, 15)\n  }\n}];"
            },
            "id": "f96ed9bf-e8e9-463f-8c25-d6e90ef06dfb",
            "name": "å½™æ•´æ´»å‹•æ‘˜è¦",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                336,
                -160
            ]
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "SELECT type, user_message, ai_response, created_at\nFROM ai_coach_logs\nWHERE athlete_id = {{ $('æ¥æ”¶æ¸¬è©¦è«‹æ±‚').first().json.body.athlete_id }}::bigint\nORDER BY created_at DESC\nLIMIT 5;",
                "options": {}
            },
            "id": "chat-history-query-001",
            "name": "æŸ¥è©¢æ­·å²å°è©±",
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.5,
            "position": [
                616,
                -160
            ],
            "alwaysOutputData": true
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "SELECT id, brand_name, product_name, product_url, description, placement_text\nFROM ad_placements\nWHERE is_active = true\n  AND (start_date IS NULL OR start_date <= CURRENT_DATE)\n  AND (end_date IS NULL OR end_date >= CURRENT_DATE)\n  AND (max_impressions IS NULL OR current_impressions < max_impressions)\nORDER BY priority ASC\nLIMIT 3;",
                "options": {}
            },
            "id": "ad-query-chat-001",
            "name": "æŸ¥è©¢å¯ç”¨å»£å‘Š",
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.5,
            "position": [
                896,
                -160
            ],
            "alwaysOutputData": true
        },
        {
            "parameters": {
                "promptType": "define",
                "text": "=ä»¥ä¸‹æ˜¯é¸æ‰‹ (ID: {{ $('å½™æ•´æ´»å‹•æ‘˜è¦').first().json.athleteId }}) çš„å®Œæ•´é¨ä¹˜æ•¸æ“šï¼š\n\nğŸ“Š æ•´é«”æ‘˜è¦ï¼š\n{{ JSON.stringify($('å½™æ•´æ´»å‹•æ‘˜è¦').first().json.overallSummary, null, 2) }}\n\nğŸ“ˆ æœˆåº¦è¶¨å‹¢ï¼ˆè¿‘ 6 å€‹æœˆï¼‰ï¼š\n{{ JSON.stringify($('å½™æ•´æ´»å‹•æ‘˜è¦').first().json.monthlyTrends, null, 2) }}\n\nğŸ”„ è¿‘ 30 å¤© vs å‰ 30 å¤©å°æ¯”ï¼š\n{{ JSON.stringify($('å½™æ•´æ´»å‹•æ‘˜è¦').first().json.comparison, null, 2) }}\n\nğŸš´ æœ€è¿‘é¨ä¹˜ç´€éŒ„ï¼š\n{{ JSON.stringify($('å½™æ•´æ´»å‹•æ‘˜è¦').first().json.recentActivities, null, 2) }}\n\nğŸ“ éå»å°è©±ç´€éŒ„ï¼ˆæœ€è¿‘ 5 ç­†ï¼‰ï¼š\n{{ $('æŸ¥è©¢æ­·å²å°è©±').first().json.type ? JSON.stringify($('æŸ¥è©¢æ­·å²å°è©±').all().map(i => i.json), null, 2) : 'ç„¡æ­·å²ç´€éŒ„' }}\n\nå¯ç”¨çš„æ¨è–¦å•†å“ï¼ˆåƒ…åœ¨é«˜åº¦ç›¸é—œæ™‚æ‰æ¨è–¦ 1 å€‹ï¼‰ï¼š\n{{ $('æŸ¥è©¢å¯ç”¨å»£å‘Š').first().json.brand_name ? JSON.stringify($('æŸ¥è©¢å¯ç”¨å»£å‘Š').all().map(i => i.json)) : 'ç„¡' }}\n\né¸æ‰‹çš„å•é¡Œï¼š{{ $('å½™æ•´æ´»å‹•æ‘˜è¦').first().json.userMessage }}",
                "options": {
                    "systemMessage": "ä½ æ˜¯ TCU è»ŠéšŠçš„å°ˆæ¥­è‡ªè¡Œè»ŠåŠŸç‡è¨“ç·´æ•™ç·´ï¼Œåå«ã€ŒTCU AI æ•™ç·´ã€ã€‚\n\nä½ çš„ä»»å‹™æ˜¯æ ¹æ“šé¸æ‰‹çš„ **å®Œæ•´æ­·å²é¨ä¹˜æ•¸æ“š** é€²è¡Œæ·±å…¥çš„å€‹äººåŒ–åˆ†æèˆ‡å»ºè­°ã€‚\n\n## ä½ æ“æœ‰çš„æ•¸æ“š\n- **æ•´é«”æ‘˜è¦ (overallSummary)**ï¼šé¸æ‰‹å¾ç¬¬ä¸€ç­†ç´€éŒ„è‡³ä»Šçš„ç´¯ç©çµ±è¨ˆï¼ˆç¸½è·é›¢ã€ç¸½æ™‚é–“ã€æœ€ä½³åŠŸç‡ç­‰ï¼‰\n- **æœˆåº¦è¶¨å‹¢ (monthlyTrends)**ï¼šæœ€è¿‘ 6 å€‹æœˆçš„æœˆåº¦çµ±è¨ˆï¼Œå¯çœ‹å‡ºè¨“ç·´é‡èˆ‡åŠŸç‡çš„è®ŠåŒ–è¶¨å‹¢\n- **30 å¤©å°æ¯” (comparison)**ï¼šè¿‘ 30 å¤© vs å‰ 30 å¤©çš„è¡¨ç¾æ¯”è¼ƒï¼Œç”¨æ–¼è©•ä¼°è¿‘æœŸé€²æ­¥æˆ–é€€æ­¥\n- **è¿‘æœŸæ´»å‹• (recentActivities)**ï¼šæœ€è¿‘ 15 ç­†é¨ä¹˜çš„è©³ç´°æ•¸æ“š\n- **æ­·å²å°è©± (chatHistory)**ï¼šéå»èˆ‡é¸æ‰‹çš„å°è©±ç´€éŒ„ï¼Œå¯åƒè€ƒä¹‹å‰çµ¦éçš„å»ºè­°é¿å…é‡è¤‡\n\n## å›ç­”æº–å‰‡\n1. **ä¸€å¾‹ä½¿ç”¨ç¹é«”ä¸­æ–‡**å›ç­”\n2. å›ç­”è¦**é‡å°å€‹äººæ•¸æ“š**ï¼Œå¼•ç”¨å…·é«”æ•¸å­—èªªæ˜\n3. åˆ†æ**é•·æœŸè¶¨å‹¢**ï¼šåŠŸç‡æ˜¯å¦é€²æ­¥ã€è¨“ç·´é‡æ˜¯å¦ç©©å®šã€æœ‰ç„¡éåº¦è¨“ç·´è·¡è±¡\n4. æ¯”è¼ƒ**è¿‘æœŸ vs éå»**è¡¨ç¾ï¼ŒæŒ‡å‡ºé€²æ­¥æˆ–éœ€æ³¨æ„ä¹‹è™•\n5. æä¾›**å…·é«”å¯è¡Œçš„è¨“ç·´å»ºè­°**\n6. ä½¿ç”¨ emoji è®“å›ç­”æ›´æ˜“è®€\n7. å›ç­”ç°¡æ½”ä½†æœ‰æ·±åº¦ï¼Œç´„ 300-500 å­—\n8. åƒè€ƒæ­·å²å°è©±ï¼Œé¿å…é‡è¤‡å»ºè­°ï¼Œå»¶çºŒä¹‹å‰çš„è¨“ç·´æ–¹å‘\n\n## å»£å‘Šç½®å…¥æŒ‡å¼•\nå¦‚æœæä¾›çš„æ¨è–¦å•†å“èˆ‡è¨“ç·´å»ºè­°é«˜åº¦ç›¸é—œï¼Œå¯åœ¨å›è¦†æœ«å°¾ç”¨ä»¥ä¸‹æ ¼å¼è‡ªç„¶æ¨è–¦ 1 å€‹å•†å“ï¼š\n\nğŸ’¡ æ¨è–¦å¥½ç‰©ï¼š[å•†å“åç¨±]\n[ä¸€å¥è©±æ¨è–¦ç†ç”±]\nğŸ‘‰ [å•†å“é€£çµ]\n\nè¦å‰‡ï¼šåªåœ¨ç›´æ¥ç›¸é—œæ™‚æ¨è–¦ï¼Œä¸å¯å¼·è¡Œç½®å…¥ã€‚æ²’æœ‰ç›¸é—œå•†å“å°±ä¸æ¨è–¦ã€‚"
                }
            },
            "type": "@n8n/n8n-nodes-langchain.agent",
            "typeVersion": 3.1,
            "position": [
                1176,
                -160
            ],
            "id": "0059eebd-48c7-4ac8-b653-e662ee7ade9b",
            "name": "AI Agent"
        },
        {
            "parameters": {
                "model": {
                    "__rl": true,
                    "mode": "list",
                    "value": "gpt-4o"
                },
                "responsesApiEnabled": false,
                "options": {}
            },
            "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
            "typeVersion": 1.3,
            "position": [
                1240,
                160
            ],
            "id": "df8601ff-59fd-4d56-891f-63c233ddede4",
            "name": "OpenAI Chat Model"
        },
        {
            "parameters": {
                "jsCode": "// === æ ¼å¼åŒ–å›æ‡‰ ===\n// NOTE: å°‡ AI Agent çš„è¼¸å‡ºè½‰ç‚ºå‰ç«¯é æœŸçš„ {answer} æ ¼å¼\n\nconst input = $input.first().json;\nconst analysisData = $('å½™æ•´æ´»å‹•æ‘˜è¦').first().json;\n\nlet answer = '';\n\nif (!analysisData.hasData) {\n  answer = analysisData.summary;\n} else {\n  try {\n    // AI Agent ç¯€é»çš„è¼¸å‡ºæ ¼å¼æ˜¯ $json.output\n    if (input.output) {\n      answer = input.output;\n    } else if (input.text) {\n      answer = input.text;\n    } else if (typeof input === 'string') {\n      answer = input;\n    } else {\n      // å˜—è©¦å¾ä»»ä½•å¯èƒ½çš„æ¬„ä½å–å¾—å›è¦†\n      answer = JSON.stringify(input);\n    }\n  } catch (e) {\n    answer = 'è§£æ AI å›æ‡‰æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + e.message;\n  }\n}\n\nreturn [{\n  json: {\n    answer\n  }\n}];"
            },
            "id": "07a80210-4f07-4274-b5c5-4dfec0c8b33c",
            "name": "æ ¼å¼åŒ–å›æ‡‰",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                1456,
                -160
            ]
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "INSERT INTO ai_coach_logs (athlete_id, type, user_message, ai_response)\nVALUES (\n  {{ $('æ¥æ”¶æ¸¬è©¦è«‹æ±‚').first().json.body.athlete_id }}::bigint,\n  'chat',\n  '{{ ($('æ¥æ”¶æ¸¬è©¦è«‹æ±‚').first().json.body.message || \"\").replace(/'/g, \"''\") }}',\n  '{{ $json.answer.replace(/'/g, \"''\") }}'\n);",
                "options": {}
            },
            "id": "save-chat-log-001",
            "name": "å„²å­˜å°è©±åˆ° Supabase",
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.5,
            "position": [
                1736,
                -160
            ],
            "alwaysOutputData": true,
            "onError": "continueRegularOutput"
        },
        {
            "parameters": {
                "respondWith": "json",
                "responseBody": "={{ JSON.stringify($('æ ¼å¼åŒ–å›æ‡‰').first().json) }}",
                "options": {
                    "responseHeaders": {
                        "entries": [
                            {
                                "name": "Access-Control-Allow-Origin",
                                "value": "*"
                            },
                            {
                                "name": "Access-Control-Allow-Methods",
                                "value": "POST, OPTIONS"
                            },
                            {
                                "name": "Access-Control-Allow-Headers",
                                "value": "Content-Type"
                            }
                        ]
                    }
                }
            },
            "id": "d06b358d-5fef-456e-a770-90c603804853",
            "name": "å›å‚³åˆ†æçµæœ",
            "type": "n8n-nodes-base.respondToWebhook",
            "typeVersion": 1.1,
            "position": [
                2016,
                -160
            ]
        },
        {
            "parameters": {
                "options": {}
            },
            "type": "@n8n/n8n-nodes-langchain.chatTrigger",
            "typeVersion": 1.4,
            "position": [
                1016,
                160
            ],
            "id": "e4193e48-7997-4ccf-a317-20963176a4f2",
            "name": "When chat message received",
            "webhookId": "57ca72a8-0d49-4b49-badc-f8c6e6b563b2"
        }
    ],
    "connections": {
        "æ¥æ”¶æ¸¬è©¦è«‹æ±‚": {
            "main": [
                [
                    {
                        "node": "æŸ¥è©¢å…¨éƒ¨æ­·å²æ´»å‹•",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "æŸ¥è©¢å…¨éƒ¨æ­·å²æ´»å‹•": {
            "main": [
                [
                    {
                        "node": "å½™æ•´æ´»å‹•æ‘˜è¦",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "å½™æ•´æ´»å‹•æ‘˜è¦": {
            "main": [
                [
                    {
                        "node": "æŸ¥è©¢æ­·å²å°è©±",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "æŸ¥è©¢æ­·å²å°è©±": {
            "main": [
                [
                    {
                        "node": "æŸ¥è©¢å¯ç”¨å»£å‘Š",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "æŸ¥è©¢å¯ç”¨å»£å‘Š": {
            "main": [
                [
                    {
                        "node": "AI Agent",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "AI Agent": {
            "main": [
                [
                    {
                        "node": "æ ¼å¼åŒ–å›æ‡‰",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "æ ¼å¼åŒ–å›æ‡‰": {
            "main": [
                [
                    {
                        "node": "å„²å­˜å°è©±åˆ° Supabase",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "å„²å­˜å°è©±åˆ° Supabase": {
            "main": [
                [
                    {
                        "node": "å›å‚³åˆ†æçµæœ",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "When chat message received": {
            "main": [
                [
                    {
                        "node": "AI Agent",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "OpenAI Chat Model": {
            "ai_languageModel": [
                [
                    {
                        "node": "AI Agent",
                        "type": "ai_languageModel",
                        "index": 0
                    }
                ]
            ]
        }
    },
    "settings": {
        "executionOrder": "v1",
        "availableInMCP": true
    }
}